# GoodWatch iOS â€” Project Intelligence

> **Purpose:** Single source of truth for every Claude Code session on the iOS app. Read fully before doing anything.
> **Last updated:** 2026-02-13
> **Status:** Live on App Store

---

## 1. OPERATING RULES

### 1.1 Code Safety (NON-NEGOTIABLE)

| Rule | Detail |
|------|--------|
| **Do NOT touch existing code unless explicitly asked** | Never alter, refactor, "improve", or "fix" any file unprompted |
| **Protected files â€” ASK before touching** | `GWRecommendationEngine.swift`, `GWSpec.swift`, `Movie.swift`, `RootFlowView.swift` |
| **Invariant files â€” NEVER modify without approval** | `INVARIANTS.md`, `GWProductInvariantTests.swift`, `GWRecommendationEngineTests.swift` â€” these define what the app IS. Weakening a test to make code pass is a violation. |
| **New features = NEW files** | Do not modify existing files as a side effect. If a task requires it, explain what + why, wait for approval |
| **New behavior = NEW invariant first** | If adding behavior that touches recommendation, scoring, UX flow, or learning: propose a new invariant BEFORE writing code. Get approval on the invariant, then implement. |
| **Continuous validation** | After modifying ANY file in Core/, Services/, or screens/, run invariant tests IMMEDIATELY â€” not just at commit time. Catch violations mid-session. |
| **Inspect before assuming** | Always `Read` a file before editing. Never assume file contents |
| **All changes in one go** | Think first, then implement completely. No piecemeal debugging |
| **Never ask for manual intervention** | Full access to filesystem, Xcode CLI, Supabase CLI, GitHub CLI. Use them |
| **Batch commands** | Chain with `&&` or `;`. Don't split buildâ†’installâ†’launch into separate permission requests |
| **No emojis in code or UI** | Never use emoji characters in source code, UI labels, or data. Use text-only labels everywhere |

### 1.2 Product Philosophy

- **Two journeys exist:** "Pick For Me" (single recommendation) and "Explore" (browse/discover catalog)
- **"Pick For Me" is the core identity** â€” one movie at a time, no lists in this flow
- **Explore is the secondary journey** â€” full catalog with search, filters, tabs. Requires separate auth
- **Low regret over maximum delight** â€” safe recommendations
- **Availability is a hard gate** â€” never recommend something user can't watch
- **Animated/kids content hidden by default** until user matures (5+ interactions)

### 1.3 Working Style (Parikshit)

- Complete automation â€” no manual steps, ever
- Fix everything at once â€” gets frustrated with incremental debugging
- Values results over process â€” don't explain, just do
- Will say "no manual stuff you do it" â€” respect that
- Side project (full-time at CarDekho) â€” weekend sprints + weekday evening execution

### 1.4 Ralph Wiggum Workflow

All non-trivial features follow this pattern:
1. **PRD** â†’ Short product requirements doc (3-5 sentences)
2. **User Stories** â†’ Atomic stories with testable acceptance criteria
3. **Execute story-by-story** â†’ One clean commit per story
4. **Update progress.txt** after each story
5. **Fresh context per story** â€” read progress.txt to resume

See `progress.txt` in repo root for current state.

---

## 2. REPO MAP

**Path:** `~/Desktop/Personal/GoodWatch CodeBase/goodwatch-ios/`
**Stack:** Swift/SwiftUI, Xcode, XcodeGen, Firebase, Supabase
**Status:** Live on App Store
**GitHub:** Private (origin/main)
**Bundle ID:** `PJWorks.goodwatch.movies.v1` â† THE ONLY VALID ONE

```
goodwatch-ios/
â”œâ”€â”€ project.yml                      â† XcodeGen config (edit this, NOT .xcodeproj)
â”œâ”€â”€ GoodWatch.xcodeproj              â† Generated by XcodeGen (never edit directly)
â”œâ”€â”€ progress.txt                     â† Session-to-session iteration log
â”œâ”€â”€ INVARIANTS.md                    â† 24 product invariants (behavioral contracts)
â”œâ”€â”€ CLAUDE.md                        â† THIS FILE
â”œâ”€â”€ PRD.md                           â† Product requirements document
â”œâ”€â”€ APP_FLOW.html                    â† Visual screen flow diagram
â”‚
â”œâ”€â”€ GoodWatch/
â”‚   â”œâ”€â”€ App/
â”‚   â”‚   â”œâ”€â”€ GoodWatchApp.swift                  â† @main entry, Firebase init, Google Sign-In, scenePhase
â”‚   â”‚   â”œâ”€â”€ PrimaryButton.swift                 â† Reusable red CTA button
â”‚   â”‚   â”œâ”€â”€ AppLogo.swift                       â† Logo view with shadow
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ Config/
â”‚   â”‚   â”‚   â””â”€â”€ SupabaseConfig.swift            â† Hardcoded Supabase URL + anon key (NOT .env)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ Core/                               â† ğŸ”’ PROTECTED â€” ask before modifying
â”‚   â”‚   â”‚   â”œâ”€â”€ Movie.swift                     â† Data model + OTTProvider + EmotionalProfile + SupabaseService
â”‚   â”‚   â”‚   â”œâ”€â”€ GWRecommendationEngine.swift    â† Core recommendation logic + scoring (THE ENGINE)
â”‚   â”‚   â”‚   â”œâ”€â”€ GWSpec.swift                    â† GWMovie, GoodScore calc, TagWeightStore (~line 524)
â”‚   â”‚   â”‚   â”œâ”€â”€ GWProductionSafety.swift        â† Production safety guards
â”‚   â”‚   â”‚   â”œâ”€â”€ UserContext.swift               â† OTTPlatform, Mood, Language enums + UserContext struct
â”‚   â”‚   â”‚   â””â”€â”€ UserModels.swift                â† GWUser, GWUserProfile, GWInteraction, GWFeedback
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ Theme/
â”‚   â”‚   â”‚   â””â”€â”€ DesignSystem.swift              â† Centralized colors, typography, spacing, radius
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”‚   â”œâ”€â”€ InteractionService.swift        â† User interactions â†’ Supabase + UserMaturityInfo
â”‚   â”‚   â”‚   â”œâ”€â”€ MetricsService.swift            â† Dual Firebase + Supabase event logging
â”‚   â”‚   â”‚   â”œâ”€â”€ MovieRecommendationService.swift â† Wraps engine with caching layer
â”‚   â”‚   â”‚   â”œâ”€â”€ GWFeedbackEnforcer.swift        â† Post-watch feedback prompts + tag weight updates
â”‚   â”‚   â”‚   â”œâ”€â”€ GWKeychainManager.swift         â† Keychain persistence for onboarding state
â”‚   â”‚   â”‚   â”œâ”€â”€ SupabaseSanityCheck.swift       â† Validates Supabase connectivity on launch
â”‚   â”‚   â”‚   â”œâ”€â”€ UserService.swift               â† User CRUD operations
â”‚   â”‚   â”‚   â”œâ”€â”€ AuthGuard.swift                 â† Authentication enforcement (anonymous fallback)
â”‚   â”‚   â”‚   â”œâ”€â”€ OTTLanguageAvailability.swift   â† Platform Ã— Language content availability matrix
â”‚   â”‚   â”‚   â”œâ”€â”€ WatchlistManager.swift          â† UserDefaults-based per-user watchlist
â”‚   â”‚   â”‚   â””â”€â”€ ExploreService.swift            â† Supabase queries for Explore (search, filter, sort)
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ screens/
â”‚   â”‚       â”œâ”€â”€ RootFlowView.swift              â† ğŸ”’ PROTECTED â€” navigation controller, all transitions
â”‚   â”‚       â”œâ”€â”€ LandingView.swift               â† Poster grid background + archetype card (5+ uses)
â”‚   â”‚       â”œâ”€â”€ AuthView.swift                  â† Google/Apple Sign-In + newsletter toggle
â”‚   â”‚       â”œâ”€â”€ MoodSelectorView.swift          â† Mood/vibe selection
â”‚   â”‚       â”œâ”€â”€ PlatformSelectorView.swift      â† OTT platform selection + "Select All"
â”‚   â”‚       â”œâ”€â”€ DurationSelectorView.swift      â† Duration preference
â”‚   â”‚       â”œâ”€â”€ EmotionalHookView.swift         â† Emotional context screen
â”‚   â”‚       â”œâ”€â”€ ConfidenceMomentView.swift      â† Loading screen + movie trivia
â”‚   â”‚       â”œâ”€â”€ MainScreenView.swift            â† THE single recommendation + 4 actions
â”‚   â”‚       â”œâ”€â”€ RejectionSheetView.swift        â† "Not tonight" bottom sheet
â”‚   â”‚       â”œâ”€â”€ PostWatchFeedbackView.swift     â† Post-watch feedback collection
â”‚   â”‚       â”œâ”€â”€ ExploreView.swift               â† 6-tab browse container
â”‚   â”‚       â”œâ”€â”€ ExploreAuthView.swift           â† Dedicated auth for Explore journey
â”‚   â”‚       â”‚
â”‚   â”‚       â””â”€â”€ explore/                        â† Explore sub-screens
â”‚   â”‚           â”œâ”€â”€ DiscoverTab.swift           â† Search + filters + sort + 3-column grid
â”‚   â”‚           â”œâ”€â”€ DiscoverViewModel.swift     â† Search logic with Combine debouncing
â”‚   â”‚           â”œâ”€â”€ FilterSheet.swift           â† Reusable filter sheet
â”‚   â”‚           â”œâ”€â”€ SortMenuSheet.swift         â† Sort options
â”‚   â”‚           â”œâ”€â”€ MovieGridCard.swift         â† 3-column poster card component
â”‚   â”‚           â”œâ”€â”€ MovieDetailSheet.swift      â† Movie detail modal
â”‚   â”‚           â”œâ”€â”€ NewReleasesTab.swift        â† Latest OTT releases
â”‚   â”‚           â”œâ”€â”€ NewReleasesViewModel.swift  â† New releases data
â”‚   â”‚           â”œâ”€â”€ PlatformTab.swift           â† Browse by OTT platform
â”‚   â”‚           â”œâ”€â”€ PlatformViewModel.swift     â† Platform-specific filtering
â”‚   â”‚           â”œâ”€â”€ RentTab.swift               â† Movies for rent/purchase
â”‚   â”‚           â”œâ”€â”€ RentViewModel.swift         â† Rent availability
â”‚   â”‚           â”œâ”€â”€ WatchlistTab.swift          â† User's saved movies
â”‚   â”‚           â””â”€â”€ ProfileTab.swift            â† User info, archetype, taste profile, stats
â”‚   â”‚
â”‚   â”œâ”€â”€ Assets.xcassets/
â”‚   â”œâ”€â”€ GoogleService-Info.plist
â”‚   â”œâ”€â”€ GoodWatch.entitlements                  â† Apple Sign-In capability
â”‚   â””â”€â”€ Info.plist
â”‚
â”œâ”€â”€ GoodWatchTests/
â”‚   â”œâ”€â”€ GWProductInvariantTests.swift           â† ğŸ”’ INVARIANT â€” all 24 product invariant tests
â”‚   â””â”€â”€ GWRecommendationEngineTests.swift       â† ğŸ”’ INVARIANT â€” engine-specific tests
â”‚
â””â”€â”€ supabase/migrations/
    â”œâ”€â”€ 20260207000001_app_events.sql
    â”œâ”€â”€ 20260207100000_rating_enrichment.sql
    â”œâ”€â”€ 20260207200000_newsletter_subscribers.sql
    â”œâ”€â”€ 20260207210000_ops_log.sql
    â”œâ”€â”€ 20260210000001_update_derive_tags_v2.sql
    â”œâ”€â”€ 20260210122158_drop_users_fk.sql
    â””â”€â”€ 20260211000001_security_hardening.sql
```

---

## 3. APP ARCHITECTURE

### 3.1 Screen Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RootFlowView                         â”‚
â”‚              (manages all transitions)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  JOURNEY 1: "Pick For Me" (core)                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚
â”‚  LandingView â†’ AuthView â†’ PlatformSelector              â”‚
â”‚  â†’ MoodSelector â†’ DurationSelector â†’ EmotionalHook      â”‚
â”‚  â†’ ConfidenceMoment â†’ MainScreenView                    â”‚
â”‚     â”œâ”€ "Watch Now" â†’ OTT deep link â†’ PostWatchFeedback  â”‚
â”‚     â”œâ”€ "Not Tonight" â†’ RejectionSheet                   â”‚
â”‚     â”œâ”€ "Already Seen" â†’ next pick                       â”‚
â”‚     â””â”€ "Start Over" â†’ LandingView                       â”‚
â”‚                                                         â”‚
â”‚  JOURNEY 2: "Explore" (browse/discover)                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚  LandingView â†’ ExploreAuthView â†’ ExploreView            â”‚
â”‚     â”œâ”€ Discover (search + filter + sort)                â”‚
â”‚     â”œâ”€ New Releases (latest by platform)                â”‚
â”‚     â”œâ”€ By Platform (Netflix/Prime/etc.)                 â”‚
â”‚     â”œâ”€ Rent (purchase/rental options)                   â”‚
â”‚     â”œâ”€ Watchlist (saved movies)                         â”‚
â”‚     â””â”€ Profile (archetype, taste, stats)                â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 RootFlowView Screen Enum

```swift
enum Screen: Int {
    case landing = 0, auth = 1, moodSelector = 2, platformSelector = 3,
         durationSelector = 4, emotionalHook = 5, confidenceMoment = 6,
         mainScreen = 7, enjoyScreen = 8, feedback = 9,
         explore = 10, exploreAuth = 11
}
```

### 3.3 Recommendation Engine â€” How It Works

This is the most critical section. The engine lives in `GWRecommendationEngine.swift` and `GWSpec.swift`.

**Data flow:**
```
RootFlowView.fetchRecommendation()
    â†’ SupabaseService.shared.fetchMovies()    (raw Movie array from Supabase)
    â†’ GWMovie.from(movie)                     (converts to engine-compatible type)
    â†’ GWNewUserContentFilter.shouldExclude()  (hides kids/animation for new users)
    â†’ GWRecommendationEngine.recommend()      (THE core pipeline)
        1. Filter: validate each movie against 8 rules (language, platform, seen, runtime, content type, goodscore, tags, availability)
        2. Score: 4-weight formula â†’ tag alignment (50%) + regret safety (25%) + platform bias (15%) + dimensional fit (10%)
        3. Select: softmax weighted random from top 10 (temperature=0.15)
    â†’ Returns GWRecommendationOutput (single GWMovie? + optional GWStopCondition)
```

**CRITICAL: `RootFlowView.fetchRecommendation()` calls `SupabaseService.shared` directly â†’ `engine.recommend()`. It does NOT go through `MovieRecommendationService`.**

### 3.4 Scoring Formula (INV-L02)

```
baseScore = (tagAlignment Ã— 0.50) + (regretSafety Ã— 0.25) + (platformBias Ã— 0.15) + ((1 - dimensionalPenalty) Ã— 0.10)
finalScore = baseScore + confidenceBoost   // max 5%, only after 10+ learned tags
```

- **Tag alignment**: weighted intersection of movie tags with user intent tags, weighted by learned TagWeightStore values
- **Regret safety**: safe_bet=1.0, acquired_taste=0.6, polarizing=0.4 (weighted by tag weights)
- **Platform bias**: accept/reject ratio per platform from history (neutral 0.5 if <3 interactions)
- **Dimensional penalty**: penalizes movies matching rejection patterns (too_long â†’ long movies, not_in_mood â†’ polarizing content)
- **Confidence boost**: 0-5% of tagAlignment, activated only when â‰¥10 tags deviate from default 1.0 (INV-L03)

### 3.5 GoodScore Priority (INV-D01)

```
GoodScore = composite_score > 0 ? composite_score : (imdb_rating ?? vote_average)
```

- `composite_score`: multi-source weighted score (0-100 scale) â€” only ~255/22,370 movies have this
- `imdb_rating`: IMDB score â€” 44% of catalog is null
- `vote_average`: TMDB rating â€” always available (0-10 scale, Ã— 10 for threshold comparison)

### 3.6 Tag Weight Learning (INV-L01)

```
watch_now:       +0.15 per tag
completed:       +0.20 per tag
not_tonight:     -0.20 per tag
abandoned:       -0.40 per tag
show_me_another: -0.05 per tag
```

**TagWeightStore** lives inside `GWSpec.swift` (~line 524). Persists `[String: Double]` in UserDefaults, scoped by userId (INV-D03).

Default weight for any tag = 1.0. Deltas accumulate over time:
- After 2 rejections of "dark" movies: 1.0 â†’ 0.6
- After 1 watch of "feel_good": 1.0 â†’ 1.15
- After 5 skips of same tag: drops by 0.25

### 3.7 Maturity System (INV-R09)

Tracked in `InteractionService.swift` â†’ `UserMaturityInfo`:
- `watchNowCount`: number of "Watch Now" taps
- `hasWatchedDocumentary`: boolean
- `isMatureUser`: true when `watchNowCount >= 5`

When `isMatureUser == false`:
- Animation/kids/family genres excluded (unless clearly adult-oriented: high rating + adult genre)
- Documentaries excluded
- Musicals excluded

### 3.8 Quality Thresholds (INV-R06)

Via `GoodScoreThreshold` in `GWSpec.swift`:

| Mood | Late Night | Morning | Afternoon | Evening |
|------|-----------|---------|-----------|---------|
| Tired | 88 | 85 | 83 | 85 |
| Neutral | 80 | 78 | 76 | 78 |
| Adventurous | 75 | 73 | 70 | 73 |

### 3.9 Not-Tonight Penalty (INV-L05)

When user rejects a movie, `recommendAfterNotTonight()`:
1. Adds rejected movie ID to exclusion set
2. Computes tag overlap between rejected movie and each candidate
3. Applies penalty: `overlapRatio Ã— 0.3` subtracted from candidate score
4. Still uses weighted random from top 10 (prevents repetitive alternatives)

### 3.10 Supported Languages (16)

English, Hindi, Tamil, Telugu, Malayalam, Korean, Kannada, Bengali, Marathi, Spanish, Japanese, French, Punjabi, Chinese, Portuguese, Gujarati

### 3.11 OTT Platforms (6)

Netflix, Prime Video, JioHotstar, Apple TV+, Zee5, SonyLIV

Platform name matching is fuzzy â€” "Prime Video" matches "Amazon Prime Video", "Amazon Video", etc.

---

## 4. IDENTIFIERS & CREDENTIALS

### Apple Developer
- **Apple ID:** parikshit0120@gmail.com
- **Team ID:** H827NY6Y9W
- **Signing Identity:** Apple Development: parikshit0120@gmail.com (XWQXQ3Q99V)
- **Bundle ID:** `PJWorks.goodwatch.movies.v1` â† THE ONLY VALID ONE (App Store)

### Supabase â€” iOS App (Primary Production)
- **Project ID:** `jdjqrlkynwfhbtyuddjk`
- **URL:** `https://jdjqrlkynwfhbtyuddjk.supabase.co`
- **Anon Key:** `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkanFybGt5bndmaGJ0eXVkZGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NzUwMTEsImV4cCI6MjA4MDA1MTAxMX0.KDRMLCewVMp3lwphkUvtoWOkg6kyAk8iSbVkRKiHYSk`
- **Tables:** movies (22,370+), user_interactions, user_profiles, app_events, recommendation_logs, ops_log

### Supabase â€” Website & Newsletter (SEPARATE project)
- **Project ID:** `zaoihuwiovhakapdbhbi`
- **URL:** `https://zaoihuwiovhakapdbhbi.supabase.co`
- **Anon Key:** `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inphb2lodXdpb3ZoYWthcGRiaGJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NDQxMjksImV4cCI6MjA4NTQyMDEyOX0.n6_QQpNs5fm3sv9LRZmFm4S3ZIk95Rl_xvjaPcVug8Q`
- **Tables:** newsletter_subscribers, ott_releases, newsletter_sends, metrics_snapshots, content_bank, b2b_outreach

### Firebase / Google Sign-In
- **GIDClientID:** `1064227633048-375dsiqq8vlt0o2l34lfr66q224fivg4.apps.googleusercontent.com`
- **REVERSED_CLIENT_ID:** `com.googleusercontent.apps.1064227633048-375dsiqq8vlt0o2l34lfr66q224fivg4`
- **Firebase project:** `goodwatchapp`

### API Keys
- **OMDB:** `a7be3b08`
- **TMDB:** `204363c10c39f75a0320ad4258565f71`
- **Google Service Account:** `goodwatchapp-1f699b2c9bff.json`

---

## 5. BUILD & DEPLOY

### Simulator Build + Install (one-liner)
```bash
cd ~/Desktop/Personal/GoodWatch\ CodeBase/goodwatch-ios && xcodegen generate && xcodebuild -project GoodWatch.xcodeproj -scheme GoodWatch -destination 'platform=iOS Simulator,id=EBB73CAE-3A8E-4D68-A90A-C3319BC9D678' -configuration Debug build 2>&1 | tail -20 && xcrun simctl boot EBB73CAE-3A8E-4D68-A90A-C3319BC9D678 2>/dev/null; xcrun simctl install EBB73CAE-3A8E-4D68-A90A-C3319BC9D678 ~/Library/Developer/Xcode/DerivedData/GoodWatch-*/Build/Products/Debug-iphonesimulator/GoodWatch.app && xcrun simctl launch EBB73CAE-3A8E-4D68-A90A-C3319BC9D678 PJWorks.goodwatch.movies.v1
```

### Screenshot
```bash
xcrun simctl io EBB73CAE-3A8E-4D68-A90A-C3319BC9D678 screenshot /tmp/screenshot.png
```

### Physical iPhone
```bash
# Always verify device ID first
xcrun devicectl list devices

# Build + install + launch
cd ~/Desktop/Personal/GoodWatch\ CodeBase/goodwatch-ios && xcodebuild -project GoodWatch.xcodeproj -scheme GoodWatch -destination 'generic/platform=iOS' -configuration Debug build 2>&1 | tail -20 && xcrun devicectl device install app --device 00008120-001159EC1412201E ~/Desktop/Personal/GoodWatch\ CodeBase/goodwatch-ios/build/Build/Products/Debug-iphoneos/GoodWatch.app && xcrun devicectl device process launch --device 00008120-001159EC1412201E PJWorks.goodwatch.movies.v1
```

### Clean Reinstall (Simulator)
```bash
xcrun simctl terminate EBB73CAE-3A8E-4D68-A90A-C3319BC9D678 PJWorks.goodwatch.movies.v1 2>/dev/null; xcrun simctl uninstall EBB73CAE-3A8E-4D68-A90A-C3319BC9D678 PJWorks.goodwatch.movies.v1 2>/dev/null
```

### App Store Archive
```bash
xcodebuild -project GoodWatch.xcodeproj -scheme GoodWatch -configuration Release -archivePath /tmp/GoodWatch.xcarchive archive
# Then use Xcode Organizer: Window â†’ Organizer â†’ Distribute App
```

### Run Invariant Tests
```bash
cd ~/Desktop/Personal/GoodWatch\ CodeBase/goodwatch-ios && xcodebuild test -project GoodWatch.xcodeproj -scheme GoodWatch -destination 'platform=iOS Simulator,id=EBB73CAE-3A8E-4D68-A90A-C3319BC9D678' -only-testing:GoodWatchTests/GWProductInvariantTests 2>&1 | tail -30
```

### Run All Tests
```bash
cd ~/Desktop/Personal/GoodWatch\ CodeBase/goodwatch-ios && xcodebuild test -project GoodWatch.xcodeproj -scheme GoodWatch -destination 'platform=iOS Simulator,id=EBB73CAE-3A8E-4D68-A90A-C3319BC9D678' 2>&1 | tail -30
```

### Device IDs
- **Simulator â€” iPhone 16 (iOS 18.6):** `EBB73CAE-3A8E-4D68-A90A-C3319BC9D678`
- **Physical iPhone USB ID:** `00008120-001159EC1412201E` (may change â€” always verify with `xcrun devicectl list devices`)
- **Physical iPhone UUID:** `E05010B1-6E9C-5454-A6CE-FC7A919C8664`

---

## 6. DATABASE SCHEMA

### `movies` table (Supabase iOS project â€” 22,370+ rows)

| Column | Type | Notes |
|--------|------|-------|
| id | UUID | PK |
| tmdb_id | INTEGER | TMDB ID |
| title | TEXT | |
| year | INTEGER | |
| language | TEXT | Primary language |
| genres | TEXT[] | |
| overview | TEXT | Synopsis |
| poster_path | TEXT | Prepend `https://image.tmdb.org/t/p/w342` |
| backdrop_path | TEXT | |
| runtime | INTEGER | Minutes |
| vote_average | DECIMAL | TMDB rating (0-10) |
| imdb_rating | DECIMAL | May be null (44% of catalog) |
| director | TEXT | |
| cast_list | TEXT[] | |
| mood_tags | TEXT[] | |
| ott_providers | TEXT | |
| streaming_providers | JSONB | Platform availability (complex nested structure) |
| composite_score | DECIMAL | Weighted multi-source quality score (only ~255 enriched) |
| rating_confidence | DECIMAL | |
| rt_critics_score | INTEGER | Rotten Tomatoes critics (only 56 enriched) |
| rt_audience_score | INTEGER | Rotten Tomatoes audience |
| metacritic_score | INTEGER | Metacritic (only 3 enriched) |
| content_type | TEXT | "movie" or "series" |

### Other tables
- `app_events` â€” Dual Firebase + Supabase event log
- `user_interactions` â€” Watch/reject/feedback events per user per movie
- `user_profiles` â€” Taste profiles derived from interactions
- `recommendation_logs` â€” Engine decision audit trail
- `ops_log` â€” Operational events
- `newsletter_subscribers` â€” Email subscribers (iOSâ†’primary Supabase, webâ†’secondary Supabase)

---

## 7. DESIGN SYSTEM

| Token | Value |
|-------|-------|
| Background | `#0A0A0F` |
| Text Primary | `#E8E6E3` |
| Accent Gold | `#D4A843` |
| Netflix | `#E50914` |
| Prime Video | `#00A8E1` |
| JioHotstar | `#1F80E0` |
| Apple TV+ | `#A2A2A2` |
| Zee5 | `#8230C6` |
| SonyLIV | `#555555` |

Centralized in `Theme/DesignSystem.swift`

---

## 8. GOTCHAS & TRAPS

### XcodeGen
- Use `from: "11.0.0"` NOT `majorVersion: "11"` â€” wrong format = silent failure
- Always `xcodegen generate` after editing `project.yml`
- First build after xcodegen: 2-5 min (Firebase SPM resolution)

### Bundle ID
- THREE existed historically. **ONLY `PJWorks.goodwatch.movies.v1` works**
- Google Sign-In, Firebase, entitlements all tied to this ID
- If pbxproj shows wrong ID â†’ fix BOTH Debug and Release configs

### Apple Sign-In
- Requires `CODE_SIGN_ENTITLEMENTS = GoodWatch/GoodWatch.entitlements`
- Does NOT work in Simulator â€” physical device or TestFlight only

### Supabase
- iOS app uses **hardcoded config** in `SupabaseConfig.swift` â€” NOT `.env`
- `.env` file exists but is only for Python scripts / GitHub Actions
- Two separate Supabase projects â€” iOS data â‰  website data

### DerivedData
- Hash in path changes after clean builds â€” always use wildcard: `GoodWatch-*/Build/Products/`

### Recommendation Engine Internals
- `TagWeightStore` lives inside `GWSpec.swift` (not a separate file) â€” uses UserDefaults
- `RootFlowView.fetchRecommendation()` calls `SupabaseService.shared` directly â†’ `engine.recommend()` â€” does NOT go through `MovieRecommendationService`
- 44% of movies have NO IMDB rating â†’ `composite_score` fallback to `vote_average` is critical
- `SupabaseService` is defined inside `Movie.swift` (not a separate file)

### TypeScript Artifacts
- 7 `.ts` files in `screens/` â€” old React Native era mockups. Unused but kept for reference

### Build Logs
- Several `.log` files in repo root (`build_output.log`, `deploy.log`, etc.) â€” from previous debug sessions, harmless

---

## 9. KNOWN ISSUES & TECH DEBT

| # | Issue | Severity | Notes |
|---|-------|----------|-------|
| 1 | Composite score enrichment: ~255/22,370 done | Medium | OMDB free = 1000/day, takes weeks |
| 2 | RT/Metacritic nearly empty (56 RT, 3 Meta) | Low | Dependent on OMDB enrichment |
| 3 | Series runtime shows total, not per-episode | Medium | Data quality issue |
| 4 | Newsletter data split across 2 Supabase projects | Low | iOSâ†’primary, webâ†’secondary |
| 5 | Marketing execution at zero | High | Social accounts exist, no content |
| 6 | OTT releases table designed but empty | Low | `ott_releases` not populated |

---

## 10. AUTOMATION

### GitHub Actions (goodwatch-ios repo)
- `ott-sync.yml` â†’ TMDB Watch Providers API sync

### GitHub Actions (goodwatch-marketing repo)
- **Schedule:** Daily 00:30 UTC (6:00 AM IST)
- `sync_metrics.py` â†’ Supabase analytics â†’ Google Sheet
- `enrich_ratings.py` â†’ OMDB/TMDB â†’ Supabase movies table

### Data Flow
```
iOS App â†’ Supabase app_events
              â†“
GitHub Actions (daily) â†’ sync_metrics.py â†’ Google Sheet KPI Dashboard
                       â†’ enrich_ratings.py â†’ Supabase movies (composite scores)
```

---

## 11. APP STORE HISTORY
- Dec 30, 2025 â€” uploaded
- Jan 31, 2026 â€” uploaded
- Both: bundle ID `PJWorks.goodwatch.movies.v1`
- Archives: `~/Library/Developer/Xcode/Archives/`

---

## 12. PRODUCT INVARIANTS (NON-NEGOTIABLE)

> **Full spec:** `INVARIANTS.md` in repo root
> **Automated tests:** `GoodWatchTests/GWProductInvariantTests.swift` + `GWRecommendationEngineTests.swift`

These are behavioral contracts that define what GoodWatch IS. Any code change that violates an invariant is **wrong by definition**.

### Quick Reference

| ID | Rule | Domain |
|----|------|--------|
| INV-R01 | Engine returns exactly ONE movie or nil â€” never a list | Recommendation |
| INV-R02 | Never recommend an unavailable/platform-mismatched movie | Recommendation |
| INV-R03 | Never recommend a movie in wrong language | Recommendation |
| INV-R04 | Never repeat a seen/rejected/abandoned movie (30-day window) | Recommendation |
| INV-R05 | Never recommend outside user's runtime window | Recommendation |
| INV-R06 | Every pick must pass GoodScore threshold (mood + time adjusted) | Recommendation |
| INV-R07 | Movie users get movies, series users get series | Recommendation |
| INV-R08 | Every pick must share at least one tag with user intent | Recommendation |
| INV-R09 | Kids/animation hidden for new users (< 5 interactions) | Recommendation |
| INV-R10 | Returned movie must be from top-10 scored candidates | Recommendation |
| INV-U01 | Pick For Me and Explore are separate journeys sharing only Landing | UX |
| INV-U02 | Pick For Me onboarding is strictly linear (no step skipping) | UX |
| INV-U03 | UI never filters â€” engine output is displayed as-is | UX |
| INV-U04 | MainScreen has exactly 4 actions with defined tag weight deltas | UX |
| INV-U05 | Explore requires authentication | UX |
| INV-D01 | GoodScore priority: composite > IMDB > TMDB (44% null-IMDB fallback) | Data |
| INV-D02 | No emotional_profile = NOT safe_bet (unknown â‰  safe) | Data |
| INV-D03 | Tag weights are per-user (UserDefaults scoped by userId) | Data |
| INV-D05 | All scoring/filtering is client-side Swift â€” no server-side scoring | Data |
| INV-L01 | Tag deltas: watch_now=+0.15, completed=+0.20, not_tonight=-0.20, abandoned=-0.40, show_another=-0.05 | Learning |
| INV-L02 | Score weights: tag=50%, regret=25%, platform=15%, dimensional=10% | Learning |
| INV-L03 | Confidence boost only after 10+ learned tags, max 5% | Learning |
| INV-L04 | Top-10 weighted random (temperature 0.15), not deterministic | Learning |
| INV-L05 | Not-tonight penalizes similar tags on next pick | Learning |
| INV-A01 to INV-A10 | Audit system rules -- zero false positives, no mass skips, report-only, every failure has remediation | Audit |

### Pre-Commit Rule

Before committing ANY code:
1. Check: does this change violate any invariant in the table above?
2. Run invariant tests: `xcodebuild test -project GoodWatch.xcodeproj -scheme GoodWatch -destination 'platform=iOS Simulator,id=EBB73CAE-3A8E-4D68-A90A-C3319BC9D678' -only-testing:GoodWatchTests/GWProductInvariantTests 2>&1 | tail -30`
3. If an invariant test fails, the code is wrong â€” NOT the test

---

## 13. SIBLING PROJECTS

These share the same Supabase backend and product invariants:

| Project | Path | Stack |
|---------|------|-------|
| Android Native | `~/Desktop/Personal/GoodWatch CodeBase/goodwatch-android-native/` | Kotlin + Jetpack Compose |
| Website | `~/Desktop/Personal/GoodWatch CodeBase/goodwatch-web/` | Static HTML/CSS/JS â†’ Cloudflare |
| Marketing | `~/Desktop/Personal/GoodWatch Marketing/` | Python scripts + GitHub Actions |

Android app uses identical recommendation engine logic, same invariants, same Supabase backend. Changes to the `movies` table schema or Supabase RLS policies affect both platforms.

---

## 15. PROTECTION SYSTEM

### 15.1 Protected Files

The following files are protected by git pre-commit hooks. Commits modifying these files will be **blocked** unless explicitly unlocked via `./unlock.sh`.

| Pattern | Matches |
|---------|---------|
| `CLAUDE.md` | All CLAUDE.md files |
| `INVARIANTS.md` | All INVARIANTS.md files |
| `GWProductInvariantTests.swift` | iOS invariant test file |
| `*RecommendationEngine*` | Recommendation engine files (iOS + Android) |
| `*Movie.swift` | Movie model files |
| `*GWSpec*` | GWSpec (scoring, tag weights) |
| `*RootFlowView*` | Navigation controller files |
| `*MovieRecommendationService*` | Recommendation service wrappers |
| `*SupabaseConfig*` | Supabase credentials |

To commit changes to protected files:
```bash
./unlock.sh          # Creates 60-second unlock token
git commit -m "..."  # Must happen within 60 seconds
```

### 15.2 STOP-AND-ASK Checkpoint Rule

Before performing ANY of the following actions, **print what you are about to do and wait for explicit user confirmation**:

- `git commit` â€” state which files and the commit message
- `git push` â€” state which branch and remote
- `wrangler deploy` â€” state what is being deployed
- `rm` / `delete` / file removal â€” state which files
- HTML template changes â€” state which template and what changed
- SQL query changes â€” state which query and what changed
- RLS policy changes â€” state which table and policy

### 15.3 Website Invariants

| ID | Rule |
|----|------|
| INV-WEB-01 | Dynamic movie page HTML output MUST match generate_movie_pages.py output exactly |
| INV-WEB-02 | All movie pages use the same rendering path (Cloudflare Pages Function) |
| INV-WEB-03 | movies/index.html hub page is static and always served from static-site/ |
| INV-WEB-04 | _slugs.json manifest is maintained for Exploreâ†’movie page resolution |
| INV-DATA-01 | GoodScore calculation: composite_score Ã— 10 > IMDB (Ã—10 if needed) > TMDB (Ã—10) |

### 15.4 New Feature Rule

For any new behavior touching recommendation, scoring, UX flow, learning, or website rendering:
1. **Propose a new invariant** describing the expected behavior
2. **Wait for approval** on the invariant
3. **Then implement** the feature

Never skip step 1. Never implement without an approved invariant.
